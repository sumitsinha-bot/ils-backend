
> ils-backend@1.0.0 start
> node server.js

info: Initializing services... {"timestamp":"2025-09-19T12:53:04.048Z"}
info: Database connected {"timestamp":"2025-09-19T12:53:04.081Z"}
info: Creating 8 mediasoup workers {"timestamp":"2025-09-19T12:53:04.082Z"}
info: Mediasoup initialized with 8 workers {"timestamp":"2025-09-19T12:53:04.183Z"}
info: RabbitMQ connected {"timestamp":"2025-09-19T12:53:04.236Z"}
info: Redis client connected {"timestamp":"2025-09-19T12:53:04.240Z"}
info: Redis client ready {"timestamp":"2025-09-19T12:53:04.243Z"}
info: Redis connected successfully {"timestamp":"2025-09-19T12:53:04.244Z"}
info: All services initialized successfully {"timestamp":"2025-09-19T12:53:04.288Z"}
info: Server running on port 3001 {"timestamp":"2025-09-19T12:53:04.289Z"}
info: User testuser1758286394694 registered successfully {"timestamp":"2025-09-19T12:53:14.919Z"}
info: User testuser1758286394694 logged in successfully {"timestamp":"2025-09-19T12:53:15.126Z"}
info: User testuser1758286420208 registered successfully {"timestamp":"2025-09-19T12:53:40.425Z"}
info: User testuser1758286420208 logged in successfully {"timestamp":"2025-09-19T12:53:40.635Z"}
info: Room created: 4129bca5-2129-4b64-9bf1-cb7753e75e59 on worker 0 {"timestamp":"2025-09-19T12:53:40.659Z"}
info: Stream created: 4129bca5-2129-4b64-9bf1-cb7753e75e59 by user 68cd5254af59678b654e5762 {"timestamp":"2025-09-19T12:53:40.667Z"}
info: Stream created: 4129bca5-2129-4b64-9bf1-cb7753e75e59 by user 68cd5254af59678b654e5762 {"timestamp":"2025-09-19T12:53:40.667Z"}
info: User 68cd5254af59678b654e5762 joined stream 4129bca5-2129-4b64-9bf1-cb7753e75e59 {"timestamp":"2025-09-19T12:53:40.683Z"}
warn: Chat message database save failed: ChatMessage validation failed: deletedReason: `null` is not a valid enum value for path `deletedReason`. {"_message":"ChatMessage validation failed","errors":{"deletedReason":{"kind":"enum","message":"`null` is not a valid enum value for path `deletedReason`.","name":"ValidatorError","path":"deletedReason","properties":{"enumValues":["spam","inappropriate","harassment","off-topic","other"],"message":"`null` is not a valid enum value for path `deletedReason`.","path":"deletedReason","type":"enum","value":null},"value":null}},"stack":"ValidationError: ChatMessage validation failed: deletedReason: `null` is not a valid enum value for path `deletedReason`.\n    at Document.invalidate (/home/pps024/Desktop/ils/backend/node_modules/mongoose/lib/document.js:3219:32)\n    at /home/pps024/Desktop/ils/backend/node_modules/mongoose/lib/document.js:3012:17\n    at /home/pps024/Desktop/ils/backend/node_modules/mongoose/lib/schematype.js:1368:9\n    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)","timestamp":"2025-09-19T12:53:40.699Z"}
error: Error publishing chat message: data is not defined {"stack":"ReferenceError: data is not defined\n    at MessageQueue.publishChatMessage (/home/pps024/Desktop/ils/backend/src/services/MessageQueue.js:158:29)\n    at ChatService.sendMessage (/home/pps024/Desktop/ils/backend/src/services/ChatService.js:61:31)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async /home/pps024/Desktop/ils/backend/src/routes/routes.chat.js:153:29","timestamp":"2025-09-19T12:53:40.700Z"}
error: RabbitMQ connection error: Channel closed by server: 404 (NOT-FOUND) with message "NOT_FOUND - no exchange 'analytics.events' in vhost '/'" {"classId":60,"code":404,"methodId":40,"stack":"Error: Channel closed by server: 404 (NOT-FOUND) with message \"NOT_FOUND - no exchange 'analytics.events' in vhost '/'\"\n    at Channel.accept (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel.js:324:19)\n    at Connection.mainAccept [as accept] (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:579:33)\n    at Socket.go (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:431:16)\n    at Socket.emit (node:events:518:28)\n    at emitReadable_ (node:internal/streams/readable:834:12)\n    at process.processTicksAndRejections (node:internal/process/task_queues:81:21)","timestamp":"2025-09-19T12:53:40.711Z"}
info: Attempting RabbitMQ reconnection 1/10 {"timestamp":"2025-09-19T12:53:40.711Z"}
warn: RabbitMQ connection closed {"timestamp":"2025-09-19T12:53:40.712Z"}
info: Attempting RabbitMQ reconnection 2/10 {"timestamp":"2025-09-19T12:53:40.712Z"}
error: Error publishing stream event Channel closed {"stack":"IllegalOperationError: Channel closed\n    at Channel.<anonymous> (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel.js:373:11)\n    at Channel.publish (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel_model.js:158:17)\n    at MessageQueue.publishStreamEvent (/home/pps024/Desktop/ils/backend/src/services/MessageQueue.js:138:32)\n    at StreamService.endStream (/home/pps024/Desktop/ils/backend/src/services/StreamService.js:253:37)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async /home/pps024/Desktop/ils/backend/src/routes/routes.stream.js:331:22","stackAtStateChange":"Stack capture: Socket error\n    at Connection.onSocketError (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:307:15)\n    at Connection.emit (node:events:518:28)\n    at Socket.go (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:434:14)\n    at Socket.emit (node:events:518:28)\n    at emitReadable_ (node:internal/streams/readable:834:12)\n    at process.processTicksAndRejections (node:internal/process/task_queues:81:21)","timestamp":"2025-09-19T12:53:40.730Z"}
error: Error publishing analytics event: Channel closed {"stack":"IllegalOperationError: Channel closed\n    at Channel.<anonymous> (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel.js:373:11)\n    at Channel.publish (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel_model.js:158:17)\n    at MessageQueue.publishAnalyticsEvent (/home/pps024/Desktop/ils/backend/src/services/MessageQueue.js:192:32)\n    at StreamService.endStream (/home/pps024/Desktop/ils/backend/src/services/StreamService.js:263:37)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async /home/pps024/Desktop/ils/backend/src/routes/routes.stream.js:331:22","stackAtStateChange":"Stack capture: Socket error\n    at Connection.onSocketError (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:307:15)\n    at Connection.emit (node:events:518:28)\n    at Socket.go (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:434:14)\n    at Socket.emit (node:events:518:28)\n    at emitReadable_ (node:internal/streams/readable:834:12)\n    at process.processTicksAndRejections (node:internal/process/task_queues:81:21)","timestamp":"2025-09-19T12:53:40.730Z"}
info: Stream ended: 4129bca5-2129-4b64-9bf1-cb7753e75e59 by user 68cd5254af59678b654e5762 {"timestamp":"2025-09-19T12:53:40.731Z"}
info: Stream ended: 4129bca5-2129-4b64-9bf1-cb7753e75e59 by user 68cd5254af59678b654e5762 {"timestamp":"2025-09-19T12:53:40.731Z"}
info: RabbitMQ connected {"timestamp":"2025-09-19T12:53:45.792Z"}
info: RabbitMQ connected {"timestamp":"2025-09-19T12:53:50.784Z"}
info: User testuser1758286458985 registered successfully {"timestamp":"2025-09-19T12:54:19.201Z"}
info: User testuser1758286458985 logged in successfully {"timestamp":"2025-09-19T12:54:19.406Z"}
info: Client connected: bisFO4BYRYhRvEgKAAAB, User: 68cd527baf59678b654e577a {"timestamp":"2025-09-19T12:54:19.429Z"}
info: Room created: bdaec5d1-6a27-4ca1-b419-2f4fec821a25 on worker 1 {"timestamp":"2025-09-19T12:54:19.436Z"}
warn: Database save failed, continuing with cache: Stream validation failed: category: Path `category` is required. {"_message":"Stream validation failed","errors":{"category":{"kind":"required","message":"Path `category` is required.","name":"ValidatorError","path":"category","properties":{"message":"Path `category` is required.","path":"category","type":"required","value":""},"value":""}},"stack":"ValidationError: Stream validation failed: category: Path `category` is required.\n    at Document.invalidate (/home/pps024/Desktop/ils/backend/node_modules/mongoose/lib/document.js:3219:32)\n    at /home/pps024/Desktop/ils/backend/node_modules/mongoose/lib/document.js:3012:17\n    at /home/pps024/Desktop/ils/backend/node_modules/mongoose/lib/schematype.js:1368:9\n    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)","timestamp":"2025-09-19T12:54:19.438Z"}
info: Stream created: bdaec5d1-6a27-4ca1-b419-2f4fec821a25 by user 68cd527baf59678b654e577a {"timestamp":"2025-09-19T12:54:19.439Z"}
info: Stream created: bdaec5d1-6a27-4ca1-b419-2f4fec821a25 by user: 68cd527baf59678b654e577a {"timestamp":"2025-09-19T12:54:19.439Z"}
info: User 68cd527baf59678b654e577a joined stream bdaec5d1-6a27-4ca1-b419-2f4fec821a25 {"timestamp":"2025-09-19T12:54:19.443Z"}
info: User 68cd527baf59678b654e577a joined stream bdaec5d1-6a27-4ca1-b419-2f4fec821a25 {"timestamp":"2025-09-19T12:54:19.444Z"}
error: RabbitMQ connection error: Channel closed by server: 404 (NOT-FOUND) with message "NOT_FOUND - no exchange 'analytics.events' in vhost '/'" {"classId":60,"code":404,"methodId":40,"stack":"Error: Channel closed by server: 404 (NOT-FOUND) with message \"NOT_FOUND - no exchange 'analytics.events' in vhost '/'\"\n    at Channel.accept (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel.js:324:19)\n    at Connection.mainAccept [as accept] (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:579:33)\n    at Socket.go (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:431:16)\n    at Socket.emit (node:events:518:28)\n    at emitReadable_ (node:internal/streams/readable:834:12)\n    at process.processTicksAndRejections (node:internal/process/task_queues:81:21)","timestamp":"2025-09-19T12:54:19.481Z"}
info: Attempting RabbitMQ reconnection 3/10 {"timestamp":"2025-09-19T12:54:19.481Z"}
warn: RabbitMQ connection closed {"timestamp":"2025-09-19T12:54:19.482Z"}
info: Attempting RabbitMQ reconnection 4/10 {"timestamp":"2025-09-19T12:54:19.482Z"}
info: Client disconnecting: bisFO4BYRYhRvEgKAAAB {"timestamp":"2025-09-19T12:54:21.435Z"}
info: Client disconnected: bisFO4BYRYhRvEgKAAAB, Reason: client namespace disconnect {"timestamp":"2025-09-19T12:54:21.436Z"}
error: Error publishing user presence: Channel closed {"stack":"IllegalOperationError: Channel closed\n    at Channel.<anonymous> (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel.js:373:11)\n    at Channel.publish (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/channel_model.js:158:17)\n    at MessageQueue.publishUserPresence (/home/pps024/Desktop/ils/backend/src/services/MessageQueue.js:223:32)\n    at StreamService.handleUserDisconnect (/home/pps024/Desktop/ils/backend/src/services/StreamService.js:292:37)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async Socket.<anonymous> (/home/pps024/Desktop/ils/backend/server.js:345:21)","stackAtStateChange":"Stack capture: Socket error\n    at Connection.onSocketError (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:307:15)\n    at Connection.emit (node:events:518:28)\n    at Socket.go (/home/pps024/Desktop/ils/backend/node_modules/amqplib/lib/connection.js:434:14)\n    at Socket.emit (node:events:518:28)\n    at emitReadable_ (node:internal/streams/readable:834:12)\n    at process.processTicksAndRejections (node:internal/process/task_queues:81:21)","timestamp":"2025-09-19T12:54:21.438Z"}
info: RabbitMQ connected {"timestamp":"2025-09-19T12:54:34.543Z"}
info: RabbitMQ connected {"timestamp":"2025-09-19T12:54:39.534Z"}
